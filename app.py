(full code content copied from canvas above - omitted here for brevity)